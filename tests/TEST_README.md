# Hash Table Test Suite

**NOTE:** This test suite was generated by Claude Code, Anthropic's official CLI for Claude AI.

## Overview

Comprehensive test suite for the Stainer Hash Table (SHT) library. The test suite contains 79 tests that cover all public API functions, runtime error conditions, abort conditions, and edge cases.

## Building and Running

```bash
make test
```

Or separately:

```bash
make ht_test
./ht_test
```

## Test Coverage

### 1. Basic Creation and Initialization (7 tests)
- ✓ Create and free table
- ✓ Create without error pointer
- ✓ Create with initial capacity
- ✓ Entry size validation (too large)
- ✓ Entry size at maximum (16KiB)
- ✓ Capacity validation (too large)
- ✓ Unusual alignment requirements

### 2. Table State Query Operations (6 tests)
- ✓ Size of empty table
- ✓ Size with entries (verify after each add)
- ✓ Size after deletion operations
- ✓ Empty status on initial table
- ✓ Empty status with entries
- ✓ Empty status after clearing all entries

### 3. Context and Configuration (4 tests)
- ✓ Hash function context
- ✓ Equality function context
- ✓ Free function context
- ✓ Load factor threshold configuration

### 4. Add Operations (3 tests)
- ✓ Add new entry
- ✓ Add duplicate entry (should not replace)
- ✓ Add multiple entries

### 5. Set Operations (3 tests)
- ✓ Set new entry
- ✓ Set existing entry (should replace)
- ✓ Set with free function (resource cleanup)

### 6. Get Operations (2 tests)
- ✓ Get existing entry
- ✓ Get nonexistent entry

### 7. Replace Operations (2 tests)
- ✓ Replace existing entry
- ✓ Replace nonexistent entry (should fail)

### 8. Swap Operations (3 tests)
- ✓ Swap existing entry (return old value)
- ✓ Swap nonexistent entry (should fail)
- ✓ Swap with separate buffers

### 9. Delete Operations (4 tests)
- ✓ Delete existing entry
- ✓ Delete nonexistent entry
- ✓ Pop existing entry (return value)
- ✓ Pop nonexistent entry

### 10. Table Growth and Collision Handling (3 tests)
- ✓ Automatic table growth and rehashing
- ✓ Collision handling with Robin Hood probing
- ✓ Excessive collisions (PSL limit)

### 11. Read-Only Iterators (5 tests)
- ✓ Iterate over empty table
- ✓ Iterate over all entries
- ✓ Multiple concurrent read-only iterators
- ✓ Maximum iterator count (32,767)
- ✓ Replace entry via read-only iterator

### 12. Read/Write Iterators (8 tests)
- ✓ Iterate over empty table
- ✓ Exclusive read/write iterator lock
- ✓ Read-only iterator blocks read/write
- ✓ Delete entries during iteration
- ✓ Replace entries during iteration
- ✓ Delete without last entry (error)
- ✓ Replace without last entry (error)
- ✓ Iterator error messages

### 13. Edge Cases and Stress Tests (3 tests)
- ✓ Delete and re-add cycles
- ✓ Wraparound deletion (circular buffer)
- ✓ String keys with dynamic allocation

### 14. Abort Conditions (26 tests)
These tests use `setjmp`/`longjmp` to verify that the library correctly aborts on programming errors:
- ✓ Invalid error code to `sht_msg()`
- ✓ Invalid entry alignment parameters to `sht_new_()` (2 tests):
  - `ealign` not a power of 2
  - `esize` not a multiple of `ealign`
- ✓ Configuration functions called after initialization (5 tests):
  - `sht_set_hash_ctx()`
  - `sht_set_eq_ctx()`
  - `sht_set_freefn()`
  - `sht_set_lft()`
  - `sht_init()` (double initialization)
- ✓ Invalid load factor threshold (2 tests):
  - Too low (< 1)
  - Too high (> 100)
- ✓ Operations on uninitialized table (11 tests):
  - `sht_size()`
  - `sht_empty()`
  - `sht_get()`
  - `sht_add()`
  - `sht_set()`
  - `sht_replace()`
  - `sht_swap()`
  - `sht_pop()`
  - `sht_delete()`
  - `sht_ro_iter()`
  - `sht_rw_iter()`
- ✓ Modification operations with active iterators (5 tests):
  - `sht_add()`
  - `sht_set()`
  - `sht_pop()`
  - `sht_delete()`
  - `sht_free()`

## Error Conditions Tested

### Runtime Errors (Return Error Codes)

All recoverable error conditions are tested:

1. **SHT_ERR_BAD_ESIZE** - Entry size exceeds 16KiB
2. **SHT_ERR_TOOBIG** - Requested table size too large (> 16,777,216)
3. **SHT_ERR_BAD_HASH** - Too many hash collisions (PSL > 127)
4. **SHT_ERR_ITER_LOCK** - Cannot acquire iterator lock
5. **SHT_ERR_ITER_COUNT** - Too many iterators (> 32,767)
6. **SHT_ERR_ITER_NO_LAST** - Iterator operation without valid last entry

### Abort Conditions (Programming Errors)

All programming errors that trigger `abort()` are tested using `setjmp`/`longjmp`:

1. Invalid error code to `sht_msg()`
2. Invalid entry alignment parameters to `sht_new_()` (2 conditions)
3. Configuration after initialization (5 conditions)
4. Invalid load factor threshold (2 conditions)
5. Operations on uninitialized table (9 conditions)
6. Modification operations with active iterators (5 conditions)

## API Coverage

### Functions Tested

Every public API function is tested with multiple scenarios:

- `SHT_NEW()` macro
- `sht_init()`
- `sht_set_hash_ctx()`
- `sht_set_eq_ctx()`
- `sht_set_freefn()`
- `sht_set_lft()`
- `sht_size()`
- `sht_empty()`
- `sht_add()`
- `sht_set()`
- `sht_get()`
- `sht_replace()`
- `sht_swap()`
- `sht_delete()`
- `sht_pop()`
- `sht_free()`
- `sht_get_err()`
- `sht_get_msg()`
- `sht_msg()`
- `sht_ro_iter()`
- `sht_rw_iter()`
- `SHT_ITER_NEXT()` macro
- `SHT_ITER_FREE()` macro
- `SHT_ITER_REPLACE()` macro
- `SHT_ITER_ERR()` macro
- `SHT_ITER_MSG()` macro
- `sht_iter_delete()`

### Argument Patterns Tested

- NULL vs non-NULL pointers where applicable
- Separate vs overlapping buffers (swap)
- Zero vs non-zero capacities
- Empty vs populated tables
- Valid vs invalid keys
- Edge case values (maximum sizes, counts, etc.)

## Test Entry Types

The test suite uses multiple entry types to verify flexibility:

1. **String entries** - Dynamic allocation with free function
2. **Integer entries** - Simple numeric key/value pairs
3. **Large entries** - Maximum size (16KiB)
4. **Aligned entries** - Unusual alignment (64-byte)

## Hash Functions Used

1. **XXH3_64bits** - Standard fast hash
2. **XXH32** - Hash with seed (context testing)
3. **Constant hash** - Returns 0 (collision testing)

## Notes

- All tests use assertions for validation
- Memory leaks are prevented through proper cleanup
- Tests are independent and can run in any order
- The `-DSHT_DOXYGEN` flag excludes the old test code in ht.c
- Abort conditions are tested using `setjmp`/`longjmp` to recover from `abort()` calls:
  - Custom abort handler captures error message via `sht_abort_print` callback
  - Uses `longjmp()` to return control to test instead of terminating program
  - Validates that correct error message was generated before abort
  - Properly restores original abort handler after each test
